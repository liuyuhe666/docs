# 如何处理重复消息 👍

在消息队列（MQ）系统中，**消息重复**是不可避免的现象（例如网络重试、Broker 重发、消费者确认丢失等），因此必须通过**幂等性机制**来保证即使同一消息被多次消费，业务结果也不会出错。

## 为什么会出现重复消息

MQ 系统中常见的重复场景：

| 环节       | 原因                                                 |
| ---------- | ---------------------------------------------------- |
| **生产者** | 发送超时重试，导致消息被多次发送                     |
| **Broker** | 存储或转发时出现异常，消息被重复投递                 |
| **消费者** | 消费成功但确认 ACK 丢失，Broker 认为未消费成功而重发 |

因此，即使 MQ 本身提供 _at-least-once_（至少一次投递）语义，也会有重复。

## 核心目标：消费幂等性（Idempotency）

**幂等性（Idempotency）** 指的是：

> 对同一条消息，无论处理多少次，结果都是一致的。

例如：

- 扣减库存一次或多次 → 只应扣一次
- 转账、下单、发优惠券等 → 不应重复执行

## 常见的幂等性实现方式

### 1️⃣ 唯一业务 ID + 去重表（最通用）

**思路**：
每条消息携带一个全局唯一的业务 ID（如订单号、消息 ID），消费者在处理时先检查是否处理过。

**实现：**

```sql
-- 去重表 (message_dedup)
CREATE TABLE message_dedup (
  msg_id VARCHAR(64) PRIMARY KEY,
  processed_at DATETIME
);
```

**伪代码：**

```python
if not exists(select 1 from message_dedup where msg_id = msg.id):
    # 处理业务逻辑
    process(msg)
    insert into message_dedup(msg_id, now())
else:
    # 已处理过
    ignore
```

👉 优点：

- 简单可靠，适用大多数业务场景

👉 缺点：

- 去重表会膨胀，需要定期清理

### 2️⃣ 业务主键天然幂等

有些业务天然具备幂等性：

- 下单时用固定 `order_id`，重复执行插入时会主键冲突（INSERT IGNORE 或 UPSERT）
- 更新类操作用 `UPDATE ... WHERE ...` 控制条件

示例：

```sql
INSERT INTO orders(order_id, amount)
VALUES ('ORD123', 100)
ON DUPLICATE KEY UPDATE amount = VALUES(amount);
```

这样即使重复插入，也不会多创建订单。

### 3️⃣ Redis 去重（高性能）

当吞吐量大时，可使用 Redis 存储已消费的消息 ID：

```python
if redis.setnx(msg.id, 1):
    redis.expire(msg.id, 3600)  # 设置过期时间
    process(msg)
else:
    # 已处理
    pass
```

👉 优点：高性能，适合高并发场景

👉 缺点：Redis 数据可能丢失（需结合持久化策略）

### 4️⃣ 消息事务 + 业务状态机

例如支付系统：

- 订单状态流转：`待支付 → 已支付 → 已完成`
- 每次消费前检查状态：若已是“已支付”，则跳过

这样重复消息不会影响最终结果。

### 5️⃣ 使用支持幂等的消息队列机制

一些 MQ 本身支持幂等性控制，例如：

- RocketMQ：支持消息键（`keys`）+ 幂等性表方案
- Kafka Exactly Once Semantics (EOS)：生产端和消费端均保证不重复

但大多数场景仍需业务侧保证幂等。

## 总结

| 方案             | 实现难度 | 性能 | 适用场景               |
| ---------------- | -------- | ---- | ---------------------- |
| 去重表（MySQL）  | 中       | 中   | 通用、低并发场景       |
| Redis 去重       | 低       | 高   | 高并发、可容忍短期重复 |
| 业务主键天然幂等 | 低       | 高   | 订单、库存类操作       |
| 状态机检查       | 中       | 中   | 状态流转类业务         |
| MQ 自带机制      | 高       | 高   | 大规模系统、复杂架构   |
