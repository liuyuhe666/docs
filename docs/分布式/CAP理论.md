# CAP 理论

CAP 理论（CAP Theorem）是分布式系统中的一个重要概念，由计算机科学家 **Eric Brewer** 在 2000 年提出，后来由 **Seth Gilbert 和 Nancy Lynch** 在 2002 年通过数学证明正式提出。CAP 是 **Consistency（一致性）**、**Availability（可用性）** 和 **Partition tolerance（分区容错性）** 三个属性的缩写。

CAP 理论的核心结论是：

> **在一个分布式系统中，最多只能同时满足 CAP 中的两个属性，而不可能三者兼得。**

## 三个属性解释

1. 一致性（Consistency）

- 各个节点的数据在任何时刻都是一致的。
- 表现为：客户端无论连接哪个节点，读取到的数据都应该是最新的。

✅ 举例：类似于传统关系型数据库事务中的强一致性（如 MySQL ACID）。

2. 可用性（Availability）

- 每个请求都能在有限时间内得到响应（成功或失败都算响应）。
- 即使部分节点失效，系统依然能够处理请求并返回结果。

✅ 举例：如果你请求一个服务，它即使不能保证返回最新数据，也必须返回一个响应（不能超时挂死）。

3. 分区容错性（Partition Tolerance）

- 系统在发生网络分区（Partition，即部分节点之间通信中断）时，仍能继续提供服务。
- 网络分区是分布式系统中不可避免的，如服务器宕机、链路断裂、网络延迟等。

✅ 举例：两个数据中心之间断网，系统仍然运行，不完全崩溃。

## CAP 不可同时满足三者

当系统发生网络分区时（这是现实中无法完全避免的），我们只能 **在一致性（C）和可用性（A）中选择一个**。

| 选择  | 意味着放弃                                               |
| ----- | -------------------------------------------------------- |
| C + P | 放弃可用性：可能拒绝部分请求以保持一致性（如强一致）     |
| A + P | 放弃一致性：仍然响应请求，但不同节点间数据可能暂时不一致 |
| C + A | 不可能实现：无法容忍网络分区（现实中难以避免）           |

## CAP 理论在实际系统中的体现

常见分布式系统选择：

| 系统                    | 类型         | 取舍（CAP）                          |
| ----------------------- | ------------ | ------------------------------------ |
| **Zookeeper**           | 协调服务     | CP：保证一致性，网络分区时可能不可用 |
| **Etcd**                | 配置中心     | CP：追求一致性，可能牺牲可用性       |
| **MongoDB（默认配置）** | NoSQL 数据库 | AP：牺牲强一致性，确保可用性         |
| **Cassandra**           | NoSQL 数据库 | AP：高可用，但数据一致性需要特殊设计 |
| **Redis（集群模式）**   | 缓存系统     | AP：更注重响应速度和可用性           |
| **HBase**               | 大数据存储   | CP：追求强一致性                     |

## 与 BASE 理论对比

CAP 通常用于解释系统设计上的权衡，而 BASE 理论是对 CAP 中“牺牲强一致性”策略的具体实践，尤其在大型互联网系统中常用：

| BASE 属性            | 含义                                 |
| -------------------- | ------------------------------------ |
| Basically Available  | 基本可用，允许系统部分失效但整体可用 |
| Soft state           | 允许中间状态存在，状态并非强一致     |
| Eventual consistency | 最终一致性，系统最终会达到一致状态   |

## 总结

- **CAP 理论不是一个设计标准，而是一个现实制约。**
- 系统不能同时满足 C、A、P，必须根据业务需求权衡取舍。
- 对于强事务、金融系统：倾向 **CP**
- 对于高可用、低延迟系统：倾向 **AP**
