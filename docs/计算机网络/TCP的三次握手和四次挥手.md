# TCP 的三次握手和四次挥手

TCP 的三次握手（Three-way Handshake）和四次挥手（Four-way Handshake）是 TCP 协议建立可靠连接和优雅终止连接的核心机制。

## 三次握手 - 建立连接

目的是同步双方的初始序列号（ISN），确认双方的收发能力正常，并协商一些参数（如 MSS）。确保双方都准备好进行数据传输。

1.  第一次握手 (SYN)：

    - 客户端向服务器发送一个 TCP 报文段。
    - 设置 `SYN` 标志位为 `1`，表示这是一个连接请求。
    - 选择一个随机的初始序列号 `seq = x`。
    - 此时客户端进入 `SYN_SENT` 状态。

2.  第二次握手 (SYN + ACK)：

    - 服务器收到客户端的 `SYN` 报文后，如果同意建立连接，则回复一个 TCP 报文段。
    - 设置 `SYN` 标志位为 `1`，表示这也是一个连接请求（服务器向客户端发起连接）。
    - 设置 `ACK` 标志位为 `1`，表示确认收到了客户端的 SYN。
    - 确认号 `ack = x + 1` (表示期望收到客户端下一个报文段的序列号是 x+1)。
    - 选择服务器自己的随机初始序列号 `seq = y`。
    - 此时服务器进入 `SYN_RECEIVED` 状态。

3.  第三次握手 (ACK)：
    - 客户端收到服务器的 `SYN + ACK` 报文后，需要向服务器发送一个确认报文。
    - 设置 `ACK` 标志位为 `1`。
    - 序列号 `seq = x + 1` (因为第一次握手的 SYN 消耗了一个序列号)。
    - 确认号 `ack = y + 1` (表示期望收到服务器下一个报文段的序列号是 y+1)。
    - 此时客户端进入 `ESTABLISHED` 状态。服务器收到这个 `ACK` 后，也进入 `ESTABLISHED` 状态。

为什么需要三次？

- 防止已失效的连接请求报文突然又传送到服务器： 如果只有两次握手，一个在网络中滞留很久的旧连接请求（SYN）到达服务器，服务器会误认为是一个新的连接请求，并回复 SYN+ACK。如果只有两次，这时连接就建立了，但客户端可能早已放弃或根本不知道这个连接，导致服务器资源浪费（等待一个不存在的客户端通信）。第三次握手让客户端有机会确认这个连接请求是否是它当前真正需要的。对于那个滞留的旧 SYN，客户端不会回复 ACK，服务器最终会超时关闭这个半开连接。
- 可靠地交换初始序列号：双方都需要确认对方收到了自己发送的初始序列号（ISN）。第一次握手，客户端告诉服务器它的 ISN (x)；第二次握手，服务器告诉客户端它收到了 x (ack=x+1) 并告知自己的 ISN (y)；第三次握手，客户端告诉服务器它收到了 y (ack=y+1)。这样双方都确认对方知道了自己的 ISN，为后续可靠传输奠定基础。
- 确认双方的收发能力：第一次握手：服务器确认客户端能发；第二次握手：客户端确认服务器能收能发；第三次握手：服务器确认客户端能收。

## 四次挥手 - 终止连接

目的是双方都确认数据传输完毕，并且双方都同意关闭连接。由于 TCP 连接是全双工的（数据可以双向独立传输），每个方向都需要单独关闭。

1.  第一次挥手 (FIN)：

    - 主动关闭方（可以是客户端或服务器，假设这里是客户端）决定关闭连接，向对方发送一个 TCP 报文段。
    - 设置 `FIN` 标志位为 `1`，表示它已经没有数据要发送了。
    - 序列号 `seq = u` (u 等于客户端之前已传送数据的最后一个字节的序列号加 1)。
    - 此时客户端进入 `FIN_WAIT_1` 状态。

2.  第二次挥手 (ACK)：

    - 被动关闭方（服务器）收到 `FIN` 报文后，立即发送一个确认报文。
    - 设置 `ACK` 标志位为 `1`。
    - 确认号 `ack = u + 1` (表示期望收到客户端下一个报文段的序列号是 u+1)。
    - 序列号 `seq = v` (v 等于服务器之前已传送数据的最后一个字节的序列号加 1)。
    - 此时服务器进入 `CLOSE_WAIT` 状态。客户端收到这个 ACK 后，进入 `FIN_WAIT_2` 状态。
    - 注意：\*\* 此时 TCP 连接处于半关闭状态 (Half-Close)。客户端到服务器的方向关闭了（客户端不再发送数据），但服务器到客户端的方向仍然可以发送数据。

3.  第三次挥手 (FIN)：

    - 当被动关闭方（服务器）也准备好关闭连接时（它把剩余数据发送完毕后），它发送一个 FIN 报文给主动关闭方（客户端）。
    - 设置 `FIN` 标志位为 `1` (通常 `ACK` 也会同时置 1)。
    - 序列号 `seq = w` (w 可能等于 v，也可能大于 v，取决于服务器在 CLOSE_WAIT 期间是否发送了数据)。
    - 确认号 `ack = u + 1` (通常与第二次挥手的 ack 相同，因为客户端在 FIN_WAIT_2 状态没有发送新数据)。
    - 此时服务器进入 `LAST_ACK` 状态。

4.  第四次挥手 (ACK)：
    - 主动关闭方（客户端）收到服务器的 `FIN` 报文后，必须发送一个确认报文。
    - 设置 `ACK` 标志位为 `1`。
    - 序列号 `seq = u + 1` (第一次挥手的 FIN 消耗了一个序列号)。
    - 确认号 `ack = w + 1`。
    - 此时客户端进入 `TIME_WAIT` 状态。客户端会等待 `2MSL` (Maximum Segment Lifetime, 报文段最大生存时间，通常为 2 分钟) 后，才真正关闭连接，进入 `CLOSED` 状态。
    - 服务器收到这个 `ACK` 后，立即关闭连接，进入 `CLOSED` 状态。

为什么需要四次？

- 全双工特性：TCP 连接的两个方向是独立的。一方发送 FIN 只表示它这个方向没有数据要发了，但另一方可能还有数据要发送。因此，关闭需要两个独立的 FIN/ACK 过程。
  - 第一次挥手 + 第二次挥手：关闭 客户端 -> 服务器 方向。
  - 第三次挥手 + 第四次挥手：关闭 服务器 -> 客户端 方向。

为什么需要 TIME_WAIT 状态？
主动关闭方（发送最后一个 ACK 的一方）需要等待 `2MSL` 时间：

1.  确保最后一个 ACK 送达：如果这个 ACK 在网络中丢失，被动关闭方（处于 LAST_ACK 状态）会超时重传它的 FIN。TIME_WAIT 状态下的客户端能收到这个重传的 FIN 并再次发送 ACK。
2.  让旧连接的报文在网络中消散：确保本次连接产生的所有报文都在网络中消失，不会影响下一个使用相同源 IP、源端口、目的 IP、目的端口的新连接（防止旧连接的延迟报文被新连接误接收）。

## 总结

```
        三次握手 (建立连接)                         四次挥手 (终止连接)
客户端                             服务器            客户端                             服务器
  |                                |                 |                                |
  | ----------- SYN (seq=x) ------> |                 | ----------- FIN (seq=u) ------> |  第一次挥手
  | (SYN_SENT)                     |                 | (FIN_WAIT_1)                  |
  |                                |                 |                                |
  | <------- SYN+ACK (seq=y,      |                 | <-------- ACK (ack=u+1) ------ |  第二次挥手
  |          ack=x+1) ------------ |                 | (FIN_WAIT_2)                  | (CLOSE_WAIT)
  |                                | (SYN_RCVD)      |                                |
  | ----------- ACK (ack=y+1) ---> |                 |                                |
  | (ESTABLISHED)                  | (ESTABLISHED)   |                                |
  |                                |                 | <-------- FIN (seq=w,        |  第三次挥手
  |         连接建立成功！          |                 |          ack=u+1) ---------- | (LAST_ACK)
  |                                |                 |                                |
  |                                |                 | ----------- ACK (ack=w+1) ---> |  第四次挥手
  |                                |                 | (TIME_WAIT)                  | (CLOSED)
  |                                |                 |  (等待 2MSL)                 |
  |                                |                 | --------- CLOSED ------------> |
```
