# Redis 持久化

Redis 提供了两种主要的持久化机制：**RDB** 和 **AOF**。从 Redis 4.0 开始，还引入了**混合持久化**的概念，结合了两者的优点。

## 1. RDB (Redis Database)

RDB 持久化方式是在**指定的时间间隔**内，将内存中的数据集快照（Snapshot）写入磁盘。它生成一个压缩的二进制文件（默认名为 `dump.rdb`）。

### 工作原理

1.  **手动触发**： 执行 `SAVE`（同步，会阻塞服务器）或 `BGSAVE`（后台异步）命令。
2.  **自动触发**： 在配置文件中设置规则，如 `save 900 1`（900 秒内有 1 个键被更改则触发）。当满足任一规则时，Redis 会 fork 一个子进程来执行 BGSAVE。
3.  **子进程工作**： 父进程继续处理客户端请求，子进程负责将内存数据写入临时 RDB 文件，完成后替换旧的 RDB 文件。**写时复制（Copy-On-Write）** 技术确保了数据的一致性。

### 优点

- **高性能**： 恢复大数据集时速度极快（比 AOF 快很多），因为是一个紧凑的单一文件。
- **紧凑的备份**： RDB 文件是压缩的二进制格式，非常适合用于灾难恢复、备份和迁移。
- **最大化性能**： 父进程在持久化时唯一的工作就是 fork 子进程，后续的持久化 I/O 操作由子进程完成，对主进程性能影响最小。

### 缺点

- **数据丢失风险**： 由于是定时快照，如果 Redis 意外宕机，从上一次快照到宕机之间的数据会丢失。
- **Fork 可能阻塞**： 如果数据集非常大，fork 子进程的过程可能会耗时较长，导致 Redis 短暂地停止服务（毫秒到秒级）。

### 适用场景

- **对数据完整性要求不高的场景**： 允许丢失几分钟的数据（例如：存储排行榜、缓存非关键性数据）。
- **需要快速灾难恢复**： RDB 文件加载速度远快于 AOF，在数据量大的情况下尤其明显。
- **适用于备份和容灾**： 单一的压缩文件可以很方便地传输到远程数据中心。
- **追求极致的性能**： RDB 对 Redis 服务本身的性能影响最小。

## 2. AOF (Append Only File)

AOF 持久化方式会**记录每一个写操作命令**，以日志的形式追加到一个文件的末尾。当 Redis 重启时，会重新执行 AOF 文件中的所有命令来重建数据。

### 工作原理

1.  **命令记录**： 每一个会改变数据集的 Redis 命令都会被追加到 AOF 缓冲区内。
2.  **文件同步 (fsync)**： 根据配置的策略，将缓冲区的内容写入并同步到磁盘的 AOF 文件。
    - `appendfsync always`： 每个写命令都同步到磁盘。**最安全，但性能最差**。
    - `appendfsync everysec`： 每秒同步一次。**默认推荐选项**，在安全性和性能之间取得了很好的平衡，最多丢失 1 秒的数据。
    - `appendfsync no`： 由操作系统决定何时同步。**性能最好，但最不安全**。
3.  **AOF 重写 (Rewrite)**： 随着时间推移，AOF 文件会变得非常大。Redis 提供了 `BGREWRITEAOF` 命令（或自动触发），会 fork 一个子进程来根据当前内存数据创建一个新的、更小的 AOF 文件，替换旧的冗长文件。

### 优点

- **极高的数据安全性**： 使用 `everysec` 策略最多丢失 1 秒数据，使用 `always` 策略则理论上不会丢失任何数据。
- **可读性**： AOF 文件是纯文本格式，记录了所有操作命令，便于理解和人工修复（虽然一般不这么做）。

### 缺点

- **文件体积大**： 即使经过重写，AOF 文件通常也比同数据集的 RDB 文件大。
- **恢复速度慢**： 恢复大数据集时，需要逐条执行命令，速度比 RDB 慢。
- **性能影响**： 在写负载高的场景下，AOF 的性能通常略低于 RDB。

### 适用场景

- **对数据完整性要求极高的场景**： 不允许丢失任何数据或最多只能丢失 1 秒的数据（例如：金融交易、用户会话）。
- **写操作不频繁的场景**： 如果主要是读操作，AOF 的性能影响可以忽略不计。

## 3. 混合持久化 (RDB + AOF) - Redis 4.0+

这是现代 Redis 部署的**推荐方式**，它结合了 RDB 的快速加载和 AOF 的数据安全性。

### 工作原理

1.  开启 AOF 功能 (`appendonly yes`)。
2.  当执行 AOF 重写时：
    - 子进程会像 RDB 持久化一样，将当前内存数据以 RDB 二进制格式写入新的 AOF 文件的前半部分。
    - 然后，子进程再将重写缓冲区的增量写命令（以 AOF 格式）追加到 RDB 数据的后面。
3.  最终生成的 AOF 文件是一个**前半段是 RDB 快照，后半段是增量 AOF 日志**的混合文件。
4.  重启加载时，先加载 RDB 部分的内容，再重放增量 AOF 命令，使得重启效率大幅提升。

### 优点

- **结合了 RDB 和 AOF 的优点**： 加载速度快，同时数据安全性高。
- **向后兼容**： 旧的 Redis 版本可以识别并跳过开头的 RDB 部分，只处理后面的 AOF 命令。

### 适用场景

- **几乎所有生产环境**： 这是目前最通用和理想的方案，在保证数据安全性的同时，极大地提升了重启速度。

## 总结与选择建议

| 特性           | RDB                    | AOF                    | 混合持久化 (推荐)      |
| :------------- | :--------------------- | :--------------------- | :--------------------- |
| **数据安全性** | 低，可能丢失几分钟数据 | 高，最多丢失 1 秒数据  | **非常高**，同 AOF     |
| **文件大小**   | 小，二进制压缩         | 大，文本格式           | **较小**，远小于纯 AOF |
| **恢复速度**   | **非常快**             | 慢                     | **快** (优于纯 AOF)    |
| **对性能影响** | 小 (fork 时可能阻塞)   | 中 (取决于 fsync 策略) | 中 (同 AOF)            |
| **可读性**     | 否 (二进制)            | **是** (文本命令)      | 否 (前 RDB 后 AOF)     |

## **如何选择？**

1.  **如果你希望获得最佳性能，并能承受数分钟的数据丢失**： 使用 **RDB**。
2.  **如果你需要最高的数据安全性，不容忍数据丢失**： 使用 **AOF** (配置为 `everysec`)。
3.  **对于绝大多数生产环境，你想要两全其美**： 使用 **混合持久化**。
    - 这是 Redis 4.0+ 的**默认推荐配置**。只需在配置文件中设置 `aof-use-rdb-preamble yes`（默认已是 yes）并开启 AOF (`appendonly yes`) 即可。

**最佳实践**： 在不确定如何选择时，**直接使用 Redis 4.0+ 并开启混合持久化**，这是最稳妥和高效的选择。同时，定期将 RDB 或 AOF 文件备份到异地，以实现完整的灾难恢复方案。
