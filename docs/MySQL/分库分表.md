# 分库分表

在 MySQL 中，“分库分表”是应对海量数据和高并发访问的一种常见数据库架构优化策略。

## 🧩 什么是分库分表？

> **分库分表（Database & Table Sharding）**，简单来说就是：
> 当单个数据库或单张表的数据量过大、性能下降时，通过“**拆分**”的方式来分散数据和负载。

可以分成两个层面：

| 类型                          | 说明                                                                               |
| ----------------------------- | ---------------------------------------------------------------------------------- |
| **分库（Database Sharding）** | 把原本放在一个数据库中的数据拆分到多个数据库中，每个数据库可以部署在不同服务器上。 |
| **分表（Table Sharding）**    | 把一张大表拆分成多张小表，可以在同一个数据库或不同数据库中。                       |

## ⚙️ 为什么要分库分表？

单库单表的瓶颈主要体现在：

- 数据量太大（表中上亿行）
- 查询慢（索引不再高效、I/O 成本高）
- 写入/更新冲突严重（锁竞争）
- 单机性能或存储达到上限

分库分表的核心目标：

> ✨ **提高性能，提升并发能力，增强可扩展性**

## 🧠 分库分表的主要策略

一般可以分为两大类：**垂直拆分** 和 **水平拆分**

### 1️⃣ 垂直拆分（Vertical Sharding）

#### ✅ 垂直分库

按**业务模块**划分数据库，比如：

| 业务     | 数据库     |
| -------- | ---------- |
| 用户相关 | user_db    |
| 订单相关 | order_db   |
| 商品相关 | product_db |

➡️ **优点**：

- 模块解耦，易于维护；
- 不同业务的负载相互隔离；
- 可独立扩容。

➡️ **缺点**：

- 无法解决单表数据量过大的问题；
- 跨库事务和关联查询复杂。

#### ✅ 垂直分表

按**字段（列）**拆分，把访问频率高或大的字段拆分出来：

| 表名        | 字段                         |
| ----------- | ---------------------------- |
| user_base   | id, name, email              |
| user_detail | id, avatar, bio, preferences |

➡️ **优点**：减少单表宽度、提高缓存命中率

➡️ **缺点**：仍然是单库、存在 join 成本

### 2️⃣ 水平拆分（Horizontal Sharding）

> 又叫“**水平分库/分表**”，即按照某种规则将数据行拆分到多个表或库中。

#### ✅ 水平分表（同库）

在同一个数据库中创建多张相同结构的表：

```
user_0, user_1, user_2, ...
```

数据分布策略常见几种：

| 策略类型     | 示例                               | 特点                         |
| ------------ | ---------------------------------- | ---------------------------- |
| **取模分片** | user_id % N                        | 简单高效，扩容麻烦           |
| **范围分片** | id 1-1 万 → 表 A；1 万-2 万 → 表 B | 扩容方便，易出现热点         |
| **哈希分片** | hash(user_id) % N                  | 数据均衡，难查询范围         |
| **时间分片** | 按月/季度/年建表                   | 适合日志、订单等时间序列数据 |

#### ✅ 水平分库

数据分布到不同数据库上，例如：

| 用户 ID 范围        | 数据库     |
| ------------------- | ---------- |
| 1–1,000,000         | user_db_01 |
| 1,000,001–2,000,000 | user_db_02 |

➡️ 优点：

- 读写压力分散；
- 可以独立扩容。

➡️ 缺点：

- 跨库查询困难；
- 分布式事务复杂；
- 主键唯一性需要额外设计（如雪花算法 Snowflake）。

## 🧰 综合策略（实际项目中）

在实际中通常会**结合使用**：

- 先 **垂直分库**（按业务拆分）
- 再 **水平分表**（按数据量拆分）

例如：

```
user_db_01.user_0
user_db_01.user_1
user_db_02.user_0
user_db_02.user_1
```

## 💡 总结

| 分类     | 拆分维度   | 优点         | 缺点           | 场景               |
| -------- | ---------- | ------------ | -------------- | ------------------ |
| 垂直分库 | 按业务模块 | 易扩展、解耦 | 跨库查询       | 业务系统复杂化     |
| 垂直分表 | 按字段     | 提高性能     | join 成本高    | 表字段多、查询频繁 |
| 水平分表 | 按行       | 单表性能提升 | 扩容复杂       | 同库多表场景       |
| 水平分库 | 按行       | 压力分散     | 分布式事务复杂 | 海量数据、高并发   |
